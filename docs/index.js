import{Midy}from"./midy/dist/midy.js";import{MIDIPlayer}from"./midi-player/src/midi-player.js";loadConfig();function applyTheme(e){const t=e.root;for(const e of t.getElementsByClassName("midi-player-btn"))e.classList.add("btn","btn-light","p-1");for(const e of t.getElementsByClassName("midi-player-text"))e.classList.add("p-1");for(const e of t.getElementsByClassName("midi-player-range"))e.classList.add("form-range","p-1")}function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function setTuningEvents(){const e=document.getElementById("tuningForm");e.addEventListener("change",e=>{const t=midy.audioContext.currentTime,o=e.target.closest("fieldset"),s=e.target,n=Number(s.value);switch(o.getAttribute("id")){case"ReverbType":return midy.setReverbType(n);case"ChorusType":return midy.setChorusType(n,t);case"ScaleOctaveTuning":return setScaleOctaveTuning(o,t);case"ChannelPressureEffects":{const e=Number(s.dataset.index);return setChannelPressureEffects(e,n,t)}case"PolyphonicKeyPressureEffects":{const e=Number(s.dataset.index);return setPolyphonicKeyPressureEffects(e,n,t)}case"ControlChangeEffects":{const e=Number(s.dataset.index);return setControlChangeEffects(e,n,t)}case"KeyBasedInstrumentControl":{const e=Number(s.dataset.index);return setKeyBasedController(e,n,t)}}})}function setScaleOctaveTuning(e,t){const s=e.querySelectorAll("input"),n=new Uint8Array(19);n[0]=127,n[1]=127,n[2]=8,n[3]=8,n[4]=3,n[5]=63,n[6]=63;for(let e=0;e<12;e++)n[e+7]=Number(s[e].value);midy.handleScaleOctaveTuning1ByteFormatSysEx(n,!0,t)}function setChannelPressureEffects(e,t,n){const s=new Uint8Array(7);s[0]=127,s[1]=127,s[2]=9,s[3]=1,s[5]=e,s[6]=t;for(let e=0;e<16;e++)s[4]=e,midy.handlePressureSysEx(s,"channelPressureTable",n)}function setPolyphonicKeyPressureEffects(e,t,n){const s=new Uint8Array(7);s[0]=127,s[1]=127,s[2]=9,s[3]=2,s[5]=e,s[6]=t;for(let e=0;e<16;e++)s[4]=e,midy.handlePressureSysEx(s,"polyphonicKeyPressureTable",n)}function setControlChangeEffects(e,t,n){const s=new Uint8Array(8);s[0]=127,s[1]=127,s[2]=9,s[3]=3,s[6]=e,s[7]=t;for(let e=0;e<16;e++){s[4]=e;for(let e=1;e<=15;e++)s[5]=e,midy.handleControlChangeSysEx(s,n);for(let e=64;e<=95;e++)s[5]=e,midy.handleControlChangeSysEx(s,n)}}function setKeyBasedController(e,t,n){const s=new Uint8Array(8);s[0]=127,s[1]=127,s[2]=10,s[3]=1,s[6]=e,s[7]=t;for(let e=0;e<16;e++){s[4]=e;for(let e=0;e<128;e++)s[5]=e,midy.handleKeyBasedInstrumentControlSysEx(s,n)}}async function setProgramChange(e,t,n){const s=midy.channels[e],i=midy.soundFontTable[t],a=midy.calcBank(s);if(i.has(a))return;const o=midiPlayer.soundFontURL,r=t.toString().padStart(3,"0"),c=s.isDrum?`${o}/128.sf3`:`${o}/${r}.sf3`;await midy.loadSoundFont(c),midy.setProgramChange(e,t,n)}function setMixerInputEvents(){const e=document.getElementById("mixerForm");e.addEventListener("change",async e=>{const s=e.target;if(s.tagName!=="INPUT")return;const r=s.closest("tr"),a=r.querySelectorAll("td"),t=midy.audioContext.currentTime,n=Number(a[1].querySelector("select").value),o=a[2].querySelector("select").value;if(o.startsWith("CC")){const e=Number(o.slice(2)),i=Math.ceil(Number(s.value)*127);if(n<0)for(let n=0;n<16;n++)midy.setControlChange(n,e,i,t);else midy.setControlChange(n,e,i,t)}else if(o.startsWith("Event")){const i=`set${o.slice(5)}`,e=Math.ceil(Number(s.value)*127);if(i==="setProgramChange")if(n<0){const n=new Array(16);for(let s=0;s<16;s++)n[s]=setProgramChange(s,e,t);await Promise.all(n)}else await setProgramChange(n,e,t);else if(n<0)for(let n=0;n<16;n++)midy[i](n,e,t);else midy[i](n,e,t)}else switch(o){case"FineTuning":{const e=(Number(s.value)-.5)*200;n<0?midy.setMasterFineTuning(e,t):midy.setFineTuning(n,e,t);break}case"CoarseTuning":{const e=(Number(s.value)*127-64)*100;n<0?midy.setMasterCoarseTuning(e,t):midy.setCoarseTuning(n,e,t);break}case"PitchBendRange":{const e=Number(s.value)*12800,a=`set${o}`;if(n<0)for(let n=0;n<16;n++)midy[a](n,e,t);else midy[a](i,e,t);break}default:{const e=Math.ceil(Number(s.value)*127);midy[`set${o}`](e,t)}}})}function setMixerButtonEvents(){const e=document.getElementById("mixerForm");e.addEventListener("click",e=>{const n=e.target.closest("button");if(!n)return;const t=n.closest("tr"),s=t.parentNode;if(n.textContent==="âž•"){const e=t.cloneNode(!0);t.insertAdjacentElement("afterend",e);const n=t.querySelectorAll("select"),s=e.querySelectorAll("select");n.forEach((e,t)=>{const n=s[t];if(!n)return;n.value=e.value,n.selectedIndex===-1&&e.selectedIndex!==-1&&(n.selectedIndex=e.selectedIndex)})}else 2<s.children.length&&t.remove()})}function setEvents(){setTuningEvents(),setMixerInputEvents(),setMixerButtonEvents()}const midy=new Midy(new AudioContext);await midy.audioContext.suspend();const midiPlayer=new MIDIPlayer(midy);midiPlayer.defaultLayout(),applyTheme(midiPlayer),document.getElementById("midi-player").appendChild(midiPlayer.root),setEvents(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("selectMIDI").onclick=()=>{document.getElementById("inputMIDI").click()},document.getElementById("inputMIDI").addEventListener("change",async e=>{await midiPlayer.handleStop();const t=e.target.files[0];if(!t)return;const n=await t.arrayBuffer(),s=new Uint8Array(n);await midiPlayer.loadMIDI(s)})